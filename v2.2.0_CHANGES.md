# Daemo Tavern v2.2.0 - AI Integration & Character Sync Update

## Summary
Major update adding AI awareness of character stats, automatic character name sync from SillyTavern, extended ability score system, and real-time token counting.

## ✅ Changes Implemented

### 1. SillyTavern Character Name Integration
- **Automatic Name Sync**: Character name now automatically pulls from the active SillyTavern character card
  - If character card name is "Jack", the title displays "Jack"
  - Updates automatically when you switch characters
  - No manual editing needed or allowed
  
- **Removed Editable Title**: Title is now read-only and always matches the SillyTavern character
  - Cannot be edited within the menu
  - Always shows "No Character Selected" when no character is active
  - Syncs with `context.name2` or character data from SillyTavern

### 2. Extended Ability Score System
- **Maximum Increased to 20**: Ability scores can now go up to 20 (previously capped at 15)
  - Allows for ability score improvements from leveling up
  - Supports epic-level characters
  - Point buy costs extended through 20:
    - 16 = 9 points
    - 17 = 12 points
    - 18 = 15 points
    - 19 = 19 points
    - 20 = 24 points
  
- **HTML Inputs Updated**: All ability score inputs now accept values 8-20
- **Note**: Standard point buy still uses 27 points, making 16+ scores very expensive

### 3. AI Model Integration (Character Stats Injection)
- **Automatic Stats Injection**: When you save your character, stats are injected into the AI's context
  - AI receives comprehensive character sheet information
  - Formatted as markdown for readability
  - Updates whenever you save
  
- **What the AI Knows**:
  - **Basic Info**: Race, class, level, background, alignment
  - **Combat Stats**: HP, AC, Speed, Proficiency Bonus
  - **Ability Scores**: All 6 scores with modifiers (e.g., "STR: 16 (+3)")
  - **Equipment**: Armor, weapon, instrument (if bard)
  - **Spellcasting**: Cantrips, spells known, spell slots by level
  - **Racial Features**: All features from selected race
  - **Class Features**: All features from selected class
  
- **Format Example**:
  ```markdown
  # Jack - D&D 5e Character Sheet
  
  **Race:** Half-Elf
  **Class:** Bard
  **Level:** 5
  **Background:** Entertainer
  **Alignment:** Chaotic Good
  
  ## Combat Stats
  **HP:** 32
  **AC:** 15
  **Speed:** 30 ft
  **Proficiency Bonus:** +3
  
  ## Ability Scores
  **STR:** 10 (+0)
  **DEX:** 16 (+3)
  **CON:** 12 (+1)
  **INT:** 10 (+0)
  **WIS:** 12 (+1)
  **CHA:** 18 (+4)
  
  ## Equipment
  **Armor:** Studded Leather
  **Weapon:** Rapier
  **Instrument:** Lute
  
  ## Spellcasting
  **Cantrips:** Vicious Mockery, Mage Hand, Prestidigitation
  **Spells Known:** Cure Wounds, Thunderwave, Healing Word, Detect Magic, Hypnotic Pattern
  **Spell Slots:** 1st: 4, 2nd: 3, 3rd: 2
  
  ## Racial Features
  - Darkvision (60 feet)
  - Fey Ancestry
  - Skill Versatility
  
  ## Class Features
  - Bardic Inspiration (d8)
  - Jack of All Trades
  - Song of Rest
  - Font of Inspiration
  ```

- **Toggle Stats Injection**: New slash command `/daemo-stats`
  - `/daemo-stats on` - Enable stats injection
  - `/daemo-stats off` - Disable stats injection
  - `/daemo-stats toggle` - Toggle on/off
  - Stats are automatically enabled when you save
  - Persists across sessions

### 4. Token Count Display
- **Real-Time Token Counter**: Shows token count of character stats in the menu header
  - Displays next to the Save button
  - Updates automatically when you save
  - Uses SillyTavern's tokenizer for accurate counts
  - Falls back to character length estimation if tokenizer unavailable
  
- **Visual Design**:
  - Styled box with border
  - Shows "Tokens: X" format
  - Bold, prominent number
  - Matches SillyTavern theme

- **Purpose**: Helps you monitor how many tokens your character sheet consumes in the AI context
  - Typical character sheet: 200-500 tokens
  - Varies based on spell count and features
  - Useful for context management

### 5. Integration Mechanics

**Prompt Injection System**:
- Uses SillyTavern's `setExtensionPrompt` API
- Injects at position 100 (early in prompt chain)
- Only injects when `statsEnabled` is true
- Stored in extension settings for persistence

**Character Name Sync**:
- Checks `context.name2` first (active character)
- Falls back to `context.characters[characterId].name`
- Updates on popup open
- Shows "No Character Selected" if no character

**Token Counting**:
- Uses `context.getTokenCount()` if available
- Falls back to `window.tokenizers.countTokens()`
- Estimates as `text.length / 4` as last resort
- Calculates full formatted stats text

## Technical Changes

### Updated Files

1. **character_creator.js**:
   - Removed `MakeCharacterTitleEditable()` function
   - Added `GetCharacterName()` function
   - Added `GenerateStatsText()` function
   - Added `InjectStatsIntoContext()` function
   - Added `CalculateTokenCount()` function
   - Updated `SaveCharacter()` to call `InjectStatsIntoContext()`
   - Updated `LoadCharacter()` to call `CalculateTokenCount()`
   - Updated ability score max validation from 15 to 20
   - Added `tokenCount` global variable
   - Character name now pulled from SillyTavern context

2. **dnd_data.js**:
   - Extended `ABILITY_POINT_COSTS` to include scores 16-20
   - Added costs: 16=9, 17=12, 18=15, 19=19, 20=24

3. **popup.html**:
   - Removed "Click to edit name" tooltip
   - Removed `character-title-clickable` class
   - Changed default title to "No Character Selected"
   - Added `header-controls` wrapper div
   - Added `token-display` div with token label and count
   - Updated all ability score inputs: `max="15"` → `max="20"`

4. **style.css**:
   - Removed `.character-title-clickable` styles
   - Removed `.character-title-clickable:hover` styles
   - Removed `.character-title-edit` styles
   - Added `.header-controls` flexbox layout
   - Added `.token-display` styling (border, padding, background)
   - Added `.token-label` styling (gray text)
   - Added `.token-count` styling (bold, colored, right-aligned)

5. **index.js**:
   - Added `GetExtensionPrompt()` function
   - Added `SetupPromptInjection()` function
   - Registers extension prompt with `setExtensionPrompt()`
   - Added `/daemo-stats` slash command
   - Command supports: on, off, toggle
   - Shows toastr notifications for state changes

6. **manifest.json**:
   - Version updated to 2.2.0

## Usage Guide

### Getting Started
1. **Open a character** in SillyTavern
2. **Click the dragon icon** to open Daemo Tavern menu
3. Character name automatically appears in the title
4. Fill out your D&D character sheet
5. **Click "Save Character"** button

### What Happens When You Save
1. Character data is saved to extension settings
2. Stats are formatted into markdown
3. Stats are injected into AI context
4. Token count is calculated and displayed
5. Success notification appears

### Using with AI
- The AI now knows your character's complete stats
- Ask questions like: "What's my spell save DC?" (AI calculates using your stats)
- Roleplay with stats awareness: "I attack with my rapier" (AI knows you have a rapier)
- The AI can reference your HP, AC, abilities automatically

### Toggle Stats Injection
Use the slash command in the chat:
- Type `/daemo-stats on` to enable
- Type `/daemo-stats off` to disable
- Type `/daemo-stats` to toggle

### Token Management
- Check the token counter in the menu header
- Higher-level characters with many spells = more tokens
- Consider token usage when managing context limits
- Typical range: 200-500 tokens per character sheet

## Benefits

### For Players
- **Seamless Integration**: Character name syncs automatically, no manual entry
- **AI Awareness**: The AI knows your stats and can reference them naturally
- **Better Roleplay**: AI responses consider your actual abilities and equipment
- **Transparency**: See exactly how many tokens your character uses
- **Epic Characters**: Support for level 20+ characters with maxed stats

### For DMs
- **Automated Tracking**: AI tracks player stats for you
- **Consistent Mechanics**: AI can calculate DCs, bonuses correctly
- **Less Repetition**: No need to remind AI of character capabilities
- **Context Management**: Monitor token usage across multiple characters

## Examples

### AI Using Your Stats

**Without Stats Injection**:
> User: "I cast Fireball!"
> 
> AI: "Roll for your spell attack! What's your spell DC?"

**With Stats Injection**:
> User: "I cast Fireball!"
> 
> AI: "You unleash a roiling ball of flame! Enemies must make a DC 15 Dexterity saving throw (your spell save DC based on CHA 18). Roll 8d6 fire damage!"

### Character Name Sync

**Before (v2.1.0)**:
- Title: "D&D 5e Character Sheet" or manually entered name
- Had to type character name twice (SillyTavern + menu)
- Could get out of sync

**After (v2.2.0)**:
- Title: Automatically shows "Jack" (from SillyTavern character card)
- Always matches the active character
- Single source of truth

### Ability Score Flexibility

**Before (v2.1.0)**:
- Max ability score: 15
- Couldn't represent leveled-up characters
- No room for racial bonuses + ASI improvements

**After (v2.2.0)**:
- Max ability score: 20
- Can represent a level 12 character with +4 ASI
- Example: Base 15 + Racial +2 + ASI +2 = 19

## Important Notes

1. **Character Name**: 
   - Always matches your SillyTavern character
   - Cannot be edited in the menu
   - Switch characters in SillyTavern, then reopen menu to update

2. **Stats Injection**:
   - Enabled by default when you save
   - Uses tokens from your context budget
   - Toggle with `/daemo-stats` command
   - Persists across sessions

3. **Token Count**:
   - Shown only in the menu (not in chat)
   - Updates when you save
   - Accuracy depends on tokenizer availability

4. **Ability Scores 16-20**:
   - Very expensive in point buy (9-24 points each)
   - Primarily for adding racial bonuses and ASI improvements
   - E.g., Buy 15 (7 pts) + Racial +2 + ASI +1 = 18

## Version
**v2.2.0** - AI Integration & Character Sync Update

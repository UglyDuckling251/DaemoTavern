# Daemon Tavern v2.3.0 - Character-Specific Daemon Profiles

## Summary
**MAJOR CHANGE**: Each character card now has its own separate Daemon Profile. When you create a profile for "Jack" and then switch to "Sam", Sam will have a completely independent profile. This ensures complete isolation between characters' D&D stats.

## ‚úÖ What Changed

### 1. Character-Specific Daemon Profiles ‚ö†Ô∏è **BREAKING CHANGE**
Previously, all characters shared the same profile data. Now, **each character has their own unique Daemon Profile** that is completely isolated from other characters.

**Before (v2.2.0)**:
- One global character sheet
- Opening the menu on "Jack" ‚Üí sees data
- Switching to "Sam" ‚Üí sees Jack's data
- Data shared across all characters ‚ùå

**After (v2.3.0)**:
- Each character has their own Daemon Profile
- Opening the menu on "Jack" ‚Üí sees Jack's profile
- Switching to "Sam" ‚Üí sees Sam's profile (or blank if not created yet)
- Complete data isolation between characters ‚úÖ

### 2. How Daemon Profiles Work

**Profile Storage**:
- Profiles are stored using unique character identifiers
- Primary ID: SillyTavern's `characterId` (e.g., `daemonProfile_char_42`)
- Fallback ID: Character name (e.g., `daemonProfile_name_Jack`)
- Each profile contains all D&D stats for that specific character

**Profile Loading**:
1. You click the dragon icon on a character card
2. The **Daemon Editor** opens
3. System checks if a Daemon Profile exists for this character
4. **If yes**: Loads that character's saved profile
5. **If no**: Shows blank form with default values

**Profile Saving**:
1. Fill out D&D stats in the Daemon Editor
2. Click **"üíæ Save Daemon Profile"**
3. Profile is saved under that character's unique ID
4. Stats are injected into AI context for that character
5. Token count is calculated

**Switching Characters**:
1. Switch to a different character in SillyTavern (e.g., from Jack to Sam)
2. Click the dragon icon again
3. Daemon Editor opens with **Sam's profile** (not Jack's!)
4. If Sam has no profile yet, you see a fresh blank form
5. Jack's profile remains untouched and can be loaded anytime by switching back to Jack

### 3. Updated Terminology

**Old Terms** ‚Üí **New Terms**:
- "Character Sheet" ‚Üí **"Daemon Profile"**
- "Daemo Tavern" ‚Üí **"Daemon Tavern"** (menu name)
- "Save Character" ‚Üí **"Save Daemon Profile"**
- Button tooltip ‚Üí **"Daemon Editor - Create/Edit Daemon Profile"**

**Consistent Naming**:
- **Daemon Tavern**: The extension name
- **Daemon Editor**: The popup menu where you edit profiles
- **Daemon Profile**: The D&D character stats for a specific character

### 4. Migration from v2.2.0

**‚ö†Ô∏è Important**: If you had a character sheet saved in v2.2.0, it will **not** automatically load in v2.3.0 due to the new storage structure.

**What to do**:
1. Open the Daemon Editor on each of your characters
2. Re-enter their D&D stats (or copy from notes if you have them)
3. Click "Save Daemon Profile" for each character
4. Your characters will now have isolated profiles

**Why this change?**:
The old system couldn't tell characters apart, causing data to be shared. The new system properly tracks which profile belongs to which character, enabling true multi-character support.

## Technical Implementation

### New Functions

**`GetCurrentCharacterId()`**:
- Retrieves the unique identifier for the current character
- Uses `context.characterId` as primary ID
- Falls back to sanitized character name
- Returns format: `char_42` or `name_Jack`

**`GetDaemonProfileKey()`**:
- Generates storage key for current character's profile
- Format: `daemonProfile_char_42` or `daemonProfile_name_Jack`
- Ensures complete isolation between characters

**`ResetToDefaults()`**:
- Resets all character data to default values
- Called when no saved profile exists for a character
- Clears UI to show fresh blank form

### Updated Functions

**`SaveCharacter()` ‚Üí `SaveCharacter()`**:
- Now saves to `profiles[profileKey]` instead of global `characterData`
- Uses character-specific key from `GetDaemonProfileKey()`
- Shows notification: "Daemon Profile saved for {Name}!"
- Logs: "Daemon Profile saved: {data} Key: {key}"

**`LoadCharacter()` ‚Üí `LoadCharacter()`**:
- Loads from `profiles[profileKey]` using character-specific key
- If profile exists: Restores all stats
- If profile doesn't exist: Calls `ResetToDefaults()`
- Logs: "Daemon Profile loaded: {data} Key: {key}" or "No Daemon Profile found"

### Storage Structure

**Before (v2.2.0)**:
```javascript
context.extensionSettings.DaemoTavern = {
    characterData: { /* single shared data */ },
    statsEnabled: true
}
```

**After (v2.3.0)**:
```javascript
context.extensionSettings.DaemoTavern = {
    profiles: {
        "daemonProfile_char_1": { /* Jack's data */ },
        "daemonProfile_char_2": { /* Sam's data */ },
        "daemonProfile_name_Gandalf": { /* Gandalf's data */ }
    },
    statsEnabled: true
}
```

## Updated Files

1. **character_creator.js**:
   - Added `currentCharacterId` variable
   - Added `GetCurrentCharacterId()` function
   - Added `GetDaemonProfileKey()` function
   - Added `ResetToDefaults()` function
   - Updated `SaveCharacter()` to use character-specific keys
   - Updated `LoadCharacter()` to use character-specific keys
   - Updated all console logs to use "Daemon Profile" terminology
   - Updated toastr notification to say "Daemon Profile saved for {Name}!"

2. **popup.html**:
   - Changed button text: "Save Character" ‚Üí "Save Daemon Profile"

3. **index.js**:
   - Updated button tooltip: "Daemo Tavern" ‚Üí "Daemon Editor - Create/Edit Daemon Profile"
   - Updated toastr notifications to say "Daemon Profile injection"

4. **manifest.json**:
   - Version updated to 2.3.0

## Usage Examples

### Example 1: Creating Profiles for Two Characters

**Step 1: Create Jack's Profile**
1. Open Jack's character card in SillyTavern
2. Click the dragon icon (Daemon Editor)
3. Title shows: "Jack"
4. Fill in stats: Half-Elf, Bard, Level 5, etc.
5. Click "üíæ Save Daemon Profile"
6. Success: "Daemon Profile saved for Jack!"

**Step 2: Create Sam's Profile**
1. Switch to Sam's character card in SillyTavern
2. Click the dragon icon (Daemon Editor)
3. Title shows: "Sam"
4. Form is **blank** (not showing Jack's data)
5. Fill in stats: Human, Fighter, Level 3, etc.
6. Click "üíæ Save Daemon Profile"
7. Success: "Daemon Profile saved for Sam!"

**Step 3: Switch Back to Jack**
1. Switch back to Jack's character card
2. Click the dragon icon
3. Title shows: "Jack"
4. **Jack's profile loads** (Half-Elf, Bard, Level 5)
5. Sam's profile is completely separate!

### Example 2: AI Interaction with Multiple Profiles

**With Jack (Bard)**:
```
You: "I cast Vicious Mockery!"
AI: "You unleash your cutting words! The target must make a DC 15 Wisdom 
     saving throw (your spell save DC based on CHA 18)..."
```

**With Sam (Fighter)**:
```
You: "I attack with my greatsword!"
AI: "You swing your greatsword! Roll a d20 and add +5 (your STR modifier 
     +3 plus proficiency bonus +2)..."
```

The AI knows each character's unique stats automatically!

### Example 3: Managing Multiple Campaigns

**Campaign 1: Jack, Level 5 Bard**
- Profile ID: `daemonProfile_char_1`
- Stats: CHA 18, Spells: 8 known, Level 3 slots

**Campaign 2: Jack, Level 1 Rogue** (different character, same name)
- Profile ID: `daemonProfile_char_27`
- Stats: DEX 16, No spells, Level 1

Even with the same character name, the profiles are completely separate because they use different character IDs!

## Benefits

### ‚úÖ Complete Isolation
- Jack's stats never appear when viewing Sam
- Sam's stats never appear when viewing Jack
- No more accidentally mixing character data

### ‚úÖ Multi-Character Support
- Create profiles for unlimited characters
- Each character maintains independent D&D stats
- Perfect for players with multiple characters or DMs managing NPCs

### ‚úÖ Campaign Management
- Use different characters in different campaigns
- Switch between characters seamlessly
- Each character's profile persists forever

### ‚úÖ AI Context Accuracy
- AI receives correct stats for the current character
- No confusion about which character is being played
- Accurate roleplay and mechanics

## Important Notes

1. **Profile IDs**: 
   - Based on SillyTavern's character ID (most reliable)
   - Falls back to character name if ID unavailable
   - Each ID creates a separate profile

2. **Blank Profiles**:
   - If you open the editor on a character with no saved profile, you'll see a blank form
   - This is expected behavior
   - Just fill it out and click "Save Daemon Profile"

3. **No Auto-Migration**:
   - Old v2.2.0 data is not automatically migrated
   - You'll need to re-create profiles for existing characters
   - This ensures clean, character-specific data

4. **Character Name Display**:
   - Title always shows the SillyTavern character name
   - This cannot be edited in the Daemon Editor
   - It updates automatically when you switch characters

## Terminology Reference

| Term | Meaning |
|------|---------|
| **Daemon Tavern** | The extension name (shown in toastr notifications) |
| **Daemon Editor** | The popup menu where you create/edit profiles |
| **Daemon Profile** | The D&D character stats for a specific character |
| **Character Card** | The SillyTavern character you're chatting with |

## Version
**v2.3.0** - Character-Specific Daemon Profiles

## Upgrade Path

**From v2.1.0 or earlier**: 
- Upgrade to v2.3.0
- Create new Daemon Profiles for each character

**From v2.2.0**:
- Upgrade to v2.3.0
- Re-create profiles (old global data won't load)
- Each character now has isolated profiles

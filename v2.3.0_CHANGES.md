# Daemon Tavern v2.3.0 - Character-Specific Daemon Profiles

## Summary
Major architectural update that makes Daemon Profiles character-specific. Each character card now has its own separate Daemon Profile, and the system has been rebranded with proper terminology (Daemon Editor, Daemon Profile).

## ✅ Changes Implemented

### 1. **Character-Specific Daemon Profiles** ✅
- **Complete Isolation**: Each character card now has its own unique Daemon Profile
  - Jack's Daemon Profile is completely separate from Sam's Daemon Profile
  - Profiles are stored by character ID
  - No cross-contamination between characters

**How It Works**:
1. Open character "Jack" → Click Daemon Editor → Create Jack's profile
2. Save Jack's profile (race, class, spells, etc.)
3. Switch to character "Sam" → Click Daemon Editor
4. **Result**: Editor shows a blank/default profile for Sam (NOT Jack's data)
5. Create and save Sam's unique profile
6. Switch back to Jack → Jack's profile loads automatically

**Storage Structure**:
```javascript
extensionSettings.DaemoTavern.daemonProfiles = {
    "0": { /* Jack's profile */ },
    "1": { /* Sam's profile */ },
    "2": { /* Alice's profile */ }
}
```

### 2. **Updated Terminology** ✅
- **Old**: "Character Sheet", "Save Character"
- **New**: "Daemon Profile", "Daemon Editor"

**Changes Throughout UI**:
- Button text: "Save Character" → **"Save Daemon Profile"**
- Notifications: "Character saved" → **"Daemon Profile saved"**
- Console logs: Use "Daemon Profile" terminology
- Slash command: References "Daemon Profile injection"
- Button tooltip: "Daemon Tavern - Daemon Editor"

**New Header**:
- **Title**: "Daemon Editor" (large, bold)
- **Subtitle**: "Create and manage Daemon Profiles for your characters"
- **Character Name**: Shows active character below header
- Clearer visual hierarchy

### 3. **Group Chat Protection** ✅
- **Daemon Editor Disabled in Group Chats**
  - Clicking dragon icon in group chat shows warning
  - Message: "Daemon Profiles are not available in group chats"
  - Prevents confusion and errors
  - Group chats have multiple characters, so single profile doesn't make sense

**Detection**:
```javascript
function IsGroupChat() {
    return context.groupId !== undefined && context.groupId !== null;
}
```

### 4. **Character Selection Validation** ✅
- **Requires Active Character**
  - Cannot open Daemon Editor without a character selected
  - Warning: "Please select a character first"
  - Prevents creating orphaned profiles

### 5. **Auto-Reset for New Characters** ✅
- **Fresh Start for Each Character**
  - First time opening editor for a character: Shows default values
  - All ability scores: 10
  - No race/class/spells selected
  - Clean slate for each new character

**Reset Function**:
- Clears all character data
- Resets UI to defaults
- Updates all displays
- Ready for new profile creation

### 6. **Character-Specific AI Injection** ✅
- **AI Only Sees Active Character's Profile**
  - Stats injection is character-specific
  - When chatting with Jack: AI gets Jack's profile
  - When chatting with Sam: AI gets Sam's profile
  - No mixing of character data

**Storage Structure**:
```javascript
extensionSettings.DaemoTavern.activeProfiles = {
    "0": "# Jack - D&D 5e Character Sheet\n...",
    "1": "# Sam - D&D 5e Character Sheet\n..."
}
```

### 7. **Improved Error Handling** ✅
- **Character ID Validation**
  - Checks for valid character ID before operations
  - Error message if no character selected
  - Prevents null/undefined errors

- **Profile Loading Safety**
  - Gracefully handles missing profiles
  - Shows defaults instead of erroring
  - Logs helpful debug messages

## Technical Implementation

### Storage Architecture

**Before (v2.2.0)**:
```javascript
// Single global character data - overwritten for each character
extensionSettings.DaemoTavern.characterData = { /* data */ }
```

**After (v2.3.0)**:
```javascript
// Separate profile for each character by ID
extensionSettings.DaemoTavern.daemonProfiles = {
    "0": { name: "Jack", race: "human", ... },
    "1": { name: "Sam", race: "elf", ... }
}

// Separate AI stats for each character
extensionSettings.DaemoTavern.activeProfiles = {
    "0": "# Jack - D&D 5e Character Sheet\n...",
    "1": "# Sam - D&D 5e Character Sheet\n..."
}
```

### Character ID Tracking

**New Variables**:
- `currentCharacterId`: Stores active character's ID as string
- `characterData.characterId`: Saved with profile for validation

**ID Sources**:
1. Primary: `context.characterId` (current active character)
2. Converted to string for consistent key format
3. Used as key in profile storage objects

### Loading Logic

**Initialization Flow**:
1. Daemon Editor opens
2. `GetCharacterName()` → Sets `currentCharacterId` and `characterData.name`
3. `LoadCharacter()` → Looks up profile by `currentCharacterId`
4. If found: Load saved profile
5. If not found: `ResetToDefaults()` → Clean slate

**Saving Flow**:
1. User clicks "Save Daemon Profile"
2. Validates `currentCharacterId` exists
3. Saves to `daemonProfiles[currentCharacterId]`
4. Injects stats to `activeProfiles[currentCharacterId]`
5. Success notification

## Updated Files

### 1. **character_creator.js**
- Added `currentCharacterId` global variable
- Added `characterId` field to `characterData` object
- Updated `SaveCharacter()` → Save to character-specific key
- Updated `LoadCharacter()` → Load from character-specific key
- Added `ResetToDefaults()` → Reset profile for new characters
- Updated `GetCharacterName()` → Also gets character ID
- Updated `InjectStatsIntoContext()` → Character-specific injection
- Updated all console logs to use "Daemon Profile" terminology
- Updated toastr notifications to use "Daemon Profile/Daemon Tavern"

### 2. **index.js**
- Added `IsGroupChat()` → Check if in group chat
- Updated button click handler → Validate character and check group chat
- Updated `GetExtensionPrompt()` → Get stats for current character only
- Updated slash command messages → "Daemon Profile" terminology
- Updated button tooltip → "Daemon Tavern - Daemon Editor"
- Updated initialization log → "Daemon Tavern initialized"

### 3. **popup.html**
- Added "Daemon Editor" header section
- Added subtitle: "Create and manage Daemon Profiles for your characters"
- Changed button text: "Save Daemon Profile"
- Added visual hierarchy with new header styling

### 4. **style.css**
- Added `.daemon-editor-header` → Header container styling
- Added `.daemon-editor-title` → Large title (2em, bold, colored)
- Added `.daemon-editor-subtitle` → Italic subtitle (gray)
- Added border separator between header and character info

### 5. **manifest.json**
- Version updated to 2.3.0

## Usage Examples

### Example 1: Creating Profiles for Multiple Characters

**Scenario**: You have Jack (Fighter) and Sam (Wizard)

1. **Select Jack's character card**
2. **Click dragon icon** → Daemon Editor opens
3. Character name shows: "Jack"
4. Set: Race = Human, Class = Fighter, STR = 16, etc.
5. **Click "Save Daemon Profile"**
6. Jack's profile saved

7. **Switch to Sam's character card**
8. **Click dragon icon** → Daemon Editor opens
9. Character name shows: "Sam"
10. **Notice**: All fields are default (NOT Jack's data!)
11. Set: Race = Elf, Class = Wizard, INT = 18, etc.
12. **Click "Save Daemon Profile"**
13. Sam's profile saved

14. **Switch back to Jack**
15. **Click dragon icon** → Jack's profile auto-loads!
16. See: Race = Human, Class = Fighter, STR = 16 (Jack's data)

### Example 2: Group Chat Protection

**Scenario**: You're in a group chat with multiple characters

1. **Open group chat** (has Jack, Sam, Alice)
2. **Click dragon icon**
3. **Warning appears**: "Daemon Profiles are not available in group chats"
4. Editor does NOT open
5. Prevents confusion about which character to configure

### Example 3: Character-Specific AI Awareness

**Scenario**: AI knows different stats for each character

**Chatting with Jack**:
- You: "I attack with my greatsword!"
- AI: "You swing your greatsword with STR +3! Roll d20+5 for attack (proficiency +2)."
  *(AI knows Jack has STR 16 and is a Fighter)*

**Switch to Sam, same prompt**:
- You: "I attack with my greatsword!"
- AI: "You're not proficient with greatswords as a Wizard. You attack at disadvantage with no proficiency bonus."
  *(AI knows Sam is a Wizard with low STR)*

## Migration from v2.2.0

**Automatic Migration**:
- Old `characterData` stored globally will still exist
- First character to open editor might inherit old data
- After saving, new character-specific system takes over

**Manual Migration** (Optional):
1. Open each character
2. Open Daemon Editor
3. Verify data looks correct
4. Click "Save Daemon Profile"
5. Repeat for all characters

**Note**: Old global storage won't interfere with new system

## Benefits

### For Players with Multiple Characters
- **No More Data Loss**: Jack's stats won't overwrite Sam's stats
- **Character Switching**: Instantly switch between characters
- **Organized Profiles**: Each character has isolated profile
- **No Manual Tracking**: System remembers everything automatically

### For Roleplayers
- **Consistent Characters**: AI always uses correct stats
- **No Confusion**: Clear which character is active
- **Group Chat Safety**: Can't accidentally create mixed profiles

### For Developers
- **Scalable Architecture**: Supports unlimited characters
- **Clean Separation**: Each profile is independent
- **Easy Debugging**: Character ID clearly identifies profiles
- **Future-Proof**: Ready for advanced features (export, import, etc.)

## Important Notes

1. **Character ID Based**: 
   - Profiles are tied to character ID (not name)
   - Renaming a character keeps the same profile
   - Deleting and recreating a character creates new ID = new profile

2. **Group Chats**:
   - Daemon Editor disabled in group chats
   - Each character in group should have profile set individually
   - Stats injection works per-character even in group contexts

3. **First Time Setup**:
   - Each character starts with default profile
   - No profile = blank editor on first open
   - Must save profile for each character individually

4. **AI Injection**:
   - Only active character's profile injected
   - Switching characters switches injected stats
   - `/daemo-stats` toggle affects all profiles globally

5. **Storage Location**:
   - Profiles: `extensionSettings.DaemoTavern.daemonProfiles[characterId]`
   - AI Stats: `extensionSettings.DaemoTavern.activeProfiles[characterId]`
   - Global toggle: `extensionSettings.DaemoTavern.statsEnabled`

## Terminology Reference

| Old Term | New Term |
|----------|----------|
| Character Sheet | Daemon Profile |
| Character Creator | Daemon Editor |
| Save Character | Save Daemon Profile |
| Character stats | Daemon Profile stats |
| D&D 5e Character Sheet (title) | Daemon Editor (title) |

## Version
**v2.3.0** - Character-Specific Daemon Profiles
